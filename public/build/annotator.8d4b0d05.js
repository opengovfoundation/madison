!function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C=[].slice,D={}.hasOwnProperty,E=function(a,b){function c(){this.constructor=a}for(var d in b)D.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},F=function(a,b){return function(){return a.apply(b,arguments)}},G=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};if(r=function(b){var c;return c=this.map(function(){var c,d,e,f;for(e="",c=this;(null!=c?c.nodeType:void 0)===Node.ELEMENT_NODE&&c!==b;)f=c.tagName.replace(":","\\:"),d=a(c.parentNode).children(f).index(c)+1,d="["+d+"]",e="/"+c.tagName.toLowerCase()+d+e,c=c.parentNode;return e}),c.get()},s=function(a){var b,c,d,e;return b=function(a){var b,c;return b=n(a),c=o(a),""+b+"["+c+"]"},e=a,c=function(a){var c;for(c="";a!==e;){if(null==a)throw new Error("Called getPathTo on a node which was not a descendant of @rootNode. "+e);c=b(a)+"/"+c,a=a.parentNode}return c="/"+c,c=c.replace(/\/$/,"")},d=this.map(function(){var a;return a=c(this)}),d.get()},j=function(a,b,c){var d,e,f,g,h,i;if(!a.hasChildNodes())throw new Error("XPath error: node has no children!");for(e=a.childNodes,f=0,h=0,i=e.length;i>h;h++)if(d=e[h],g=n(d),g===b&&(f+=1,f===c))return d;throw new Error("XPath error: wanted child not found.")},n=function(a){var b;switch(b=a.nodeName.toLowerCase()){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return b}},o=function(a){var b,c;for(b=0,c=a;c;)c.nodeName===a.nodeName&&b++,c=c.previousSibling;return b},p=null,"undefined"!=typeof Gettext&&null!==Gettext?(u=new Gettext({domain:"annotator"}),p=function(a){return u.gettext(a)}):p=function(a){return a},B=function(a){return p(a)},("undefined"!=typeof jQuery&&null!==jQuery&&null!=(z=jQuery.fn)?z.jquery:void 0)||console.error(B("Annotator requires jQuery: have you included lib/vendor/jquery.js?")),JSON&&JSON.parse&&JSON.stringify||console.error(B("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?")),a=jQuery,f={},f.flatten=function(b){var c;return(c=function(b){var d,e,f,g;for(e=[],f=0,g=b.length;g>f;f++)d=b[f],e=e.concat(d&&a.isArray(d)?c(d):d);return e})(b)},f.contains=function(a,b){var c;for(c=b;null!=c;){if(c===a)return!0;c=c.parentNode}return!1},f.getTextNodes=function(a){var b;return b=function(a){var c;if(a&&a.nodeType!==Node.TEXT_NODE){if(c=[],a.nodeType!==Node.COMMENT_NODE)for(a=a.lastChild;a;)c.push(b(a)),a=a.previousSibling;return c.reverse()}return a},a.map(function(){return f.flatten(b(this))})},f.getLastTextNodeUpTo=function(a){var b;switch(a.nodeType){case Node.TEXT_NODE:return a;case Node.ELEMENT_NODE:if(null!=a.lastChild&&(b=f.getLastTextNodeUpTo(a.lastChild),null!=b))return b}return a=a.previousSibling,null!=a?f.getLastTextNodeUpTo(a):null},f.getFirstTextNodeNotBefore=function(a){var b;switch(a.nodeType){case Node.TEXT_NODE:return a;case Node.ELEMENT_NODE:if(null!=a.firstChild&&(b=f.getFirstTextNodeNotBefore(a.firstChild),null!=b))return b}return a=a.nextSibling,null!=a?f.getFirstTextNodeNotBefore(a):null},f.readRangeViaSelection=function(a){var b;return b=f.getGlobal().getSelection(),b.removeAllRanges(),b.addRange(a.toRange()),b.toString()},f.xpathFromNode=function(a,b){var c,d;try{d=r.call(a,b)}catch(e){c=e,console.log("jQuery-based XPath construction failed! Falling back to manual."),d=s.call(a,b)}return d},f.nodeFromXPath=function(a,b){var c,d,e,f,g,h,i,k;for(g=a.substring(1).split("/"),e=b,h=0,i=g.length;i>h;h++)f=g[h],k=f.split("["),d=k[0],c=k[1],c=null!=c?parseInt((null!=c?c.split("]"):void 0)[0]):1,e=j(e,d.toLowerCase(),c);return e},f.escape=function(a){return a.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},f.uuid=function(){var a;return a=0,function(){return a++}}(),f.getGlobal=function(){return function(){return this}()},f.maxZIndex=function(b){var c,d;return c=function(){var c,e,f;for(f=[],c=0,e=b.length;e>c;c++)d=b[c],f.push("static"===a(d).css("position")?-1:parseInt(a(d).css("z-index"),10)||-1);return f}(),Math.max.apply(Math,c)},f.mousePosition=function(b,c){var d,e;return"absolute"!==(e=a(c).css("position"))&&"fixed"!==e&&"relative"!==e&&(c=a(c).offsetParent()[0]),d=a(c).offset(),{top:b.pageY-d.top,left:b.pageX-d.left}},f.preventEventDefault=function(a){return null!=a&&"function"==typeof a.preventDefault?a.preventDefault():void 0},l=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"],"undefined"!=typeof console&&null!==console)for(null==console.group&&(console.group=function(a){return console.log("GROUP: ",a)}),null==console.groupCollapsed&&(console.groupCollapsed=console.group),v=0,x=l.length;x>v;v++)k=l[v],null==console[k]&&(console[k]=function(){return console.log(B("Not implemented:")+(" console."+name))});else{for(this.console={},w=0,y=l.length;y>w;w++)k=l[w],this.console[k]=function(){};this.console.error=function(){var a;return a=1<=arguments.length?C.call(arguments,0):[],alert("ERROR: "+a.join(", "))},this.console.warn=function(){var a;return a=1<=arguments.length?C.call(arguments,0):[],alert("WARNING: "+a.join(", "))}}c=function(){function b(b,c){this.options=a.extend(!0,{},this.options,c),this.element=a(b),this._closures={},this.on=this.subscribe,this.addEvents()}return b.prototype.events={},b.prototype.options={},b.prototype.element=null,b.prototype.addEvents=function(){var a,c,d,e,f;for(e=b._parseEvents(this.events),f=[],c=0,d=e.length;d>c;c++)a=e[c],f.push(this._addEvent(a.selector,a.event,a.functionName));return f},b.prototype.removeEvents=function(){var a,c,d,e,f;for(e=b._parseEvents(this.events),f=[],c=0,d=e.length;d>c;c++)a=e[c],f.push(this._removeEvent(a.selector,a.event,a.functionName));return f},b.prototype._addEvent=function(a,c,d){var e;return e=function(a){return function(){return a[d].apply(a,arguments)}}(this),""===a&&b._isCustomEvent(c)?this.subscribe(c,e):this.element.delegate(a,c,e),this._closures[""+a+"/"+c+"/"+d]=e,this},b.prototype._removeEvent=function(a,c,d){var e;return e=this._closures[""+a+"/"+c+"/"+d],""===a&&b._isCustomEvent(c)?this.unsubscribe(c,e):this.element.undelegate(a,c,e),delete this._closures[""+a+"/"+c+"/"+d],this},b.prototype.publish=function(){return this.element.triggerHandler.apply(this.element,arguments),this},b.prototype.subscribe=function(b,c){var d;return d=function(){return c.apply(this,[].slice.call(arguments,1))},d.guid=c.guid=a.guid+=1,this.element.bind(b,d),this},b.prototype.unsubscribe=function(){return this.element.unbind.apply(this.element,arguments),this},b}(),c._parseEvents=function(a){var b,c,d,e,f,g,h;c=[];for(e in a)d=a[e],h=e.split(" "),f=2<=h.length?C.call(h,0,g=h.length-1):(g=0,[]),b=h[g++],c.push({selector:f.join(" "),event:b,functionName:d});return c},c.natives=function(){var a,b,c;return b=function(){var b,d;b=jQuery.event.special,d=[];for(a in b)D.call(b,a)&&(c=b[a],d.push(a));return d}(),"blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/).concat(b)}(),c._isCustomEvent=function(b){return b=b.split(".")[0],-1===a.inArray(b,c.natives)},e={},e.sniff=function(a){return null!=a.commonAncestorContainer?new e.BrowserRange(a):"string"==typeof a.start?new e.SerializedRange(a):a.start&&"object"==typeof a.start?new e.NormalizedRange(a):(console.error(B("Could not sniff range type")),!1)},e.nodeFromXPath=function(b,c){var d,e,g,h,i;return null==c&&(c=document),e=function(a,b){var d;null==b&&(b=null);try{return document.evaluate("."+a,c,b,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(e){return d=e,console.log("XPath evaluation failed."),console.log("Trying fallback..."),f.nodeFromXPath(a,c)}},a.isXMLDoc(document.documentElement)?(d=document.createNSResolver(null===document.ownerDocument?document.documentElement:document.ownerDocument.documentElement),h=e(b,d),h||(b=function(){var a,c,d,e;for(d=b.split("/"),e=[],a=0,c=d.length;c>a;a++)i=d[a],e.push(i&&-1===i.indexOf(":")?i.replace(/^([a-z]+)/,"xhtml:$1"):i);return e}().join("/"),g=document.lookupNamespaceURI(null),d=function(a){return"xhtml"===a?g:document.documentElement.getAttribute("xmlns:"+a)},h=e(b,d)),h):e(b)},e.RangeError=function(a){function b(a,c,d){this.type=a,this.message=c,this.parent=null!=d?d:null,b.__super__.constructor.call(this,this.message)}return E(b,a),b}(Error),e.BrowserRange=function(){function a(a){this.commonAncestorContainer=a.commonAncestorContainer,this.startContainer=a.startContainer,this.startOffset=a.startOffset,this.endContainer=a.endContainer,this.endOffset=a.endOffset}return a.prototype.normalize=function(){var a,b,c,d;if(this.tainted)return console.error(B("You may only call normalize() once on a BrowserRange!")),!1;if(this.tainted=!0,d={},this.startContainer.nodeType===Node.ELEMENT_NODE?(d.start=f.getFirstTextNodeNotBefore(this.startContainer.childNodes[this.startOffset]),d.startOffset=0):(d.start=this.startContainer,d.startOffset=this.startOffset),this.endContainer.nodeType===Node.ELEMENT_NODE){if(b=this.endContainer.childNodes[this.endOffset],null!=b){for(a=b;null!=a&&a.nodeType!==Node.TEXT_NODE;)a=a.firstChild;null!=a&&(d.end=a,d.endOffset=0)}null==d.end&&(b=this.endContainer.childNodes[this.endOffset-1],d.end=f.getLastTextNodeUpTo(b),d.endOffset=d.end.nodeValue.length)}else d.end=this.endContainer,d.endOffset=this.endOffset;for(c={},c.start=d.startOffset>0?d.start.nodeValue.length>d.startOffset?d.start.splitText(d.startOffset):d.start.nextSibling:d.start,d.start===d.end?(c.start.nodeValue.length>d.endOffset-d.startOffset&&c.start.splitText(d.endOffset-d.startOffset),c.end=c.start):(d.end.nodeValue.length>d.endOffset&&d.end.splitText(d.endOffset),c.end=d.end),c.commonAncestor=this.commonAncestorContainer;c.commonAncestor.nodeType!==Node.ELEMENT_NODE;)c.commonAncestor=c.commonAncestor.parentNode;return new e.NormalizedRange(c)},a.prototype.serialize=function(a,b){return this.normalize(a).serialize(a,b)},a}(),e.NormalizedRange=function(){function b(a){this.commonAncestor=a.commonAncestor,this.start=a.start,this.end=a.end}return b.prototype.normalize=function(){return this},b.prototype.limit=function(b){var c,d,e,f,g,h;if(c=a.grep(this.textNodes(),function(c){return c.parentNode===b||a.contains(b,c.parentNode)}),!c.length)return null;for(this.start=c[0],this.end=c[c.length-1],e=a(this.start).parents(),h=a(this.end).parents(),f=0,g=h.length;g>f;f++)if(d=h[f],-1!==e.index(d)){this.commonAncestor=d;break}return this},b.prototype.serialize=function(b,c){var d,g,h;return g=function(d,e){var g,h,i,j,k,l,m,n;for(j=c?a(d).parents(":not("+c+")").eq(0):a(d).parent(),l=f.xpathFromNode(j,b)[0],k=f.getTextNodes(j),h=k.slice(0,k.index(d)),i=0,m=0,n=h.length;n>m;m++)g=h[m],i+=g.nodeValue.length;return e?[l,i+d.nodeValue.length]:[l,i]},h=g(this.start),d=g(this.end,!0),new e.SerializedRange({start:h[0],end:d[0],startOffset:h[1],endOffset:d[1]})},b.prototype.text=function(){var a;return function(){var b,c,d,e;for(d=this.textNodes(),e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.nodeValue);return e}.call(this).join("")},b.prototype.textNodes=function(){var b,c,d,e;return d=f.getTextNodes(a(this.commonAncestor)),e=[d.index(this.start),d.index(this.end)],c=e[0],b=e[1],a.makeArray(d.slice(c,+b+1||9e9))},b.prototype.toRange=function(){var a;return a=document.createRange(),a.setStartBefore(this.start),a.setEndAfter(this.end),a},b}(),e.SerializedRange=function(){function b(a){this.start=a.start,this.startOffset=a.startOffset,this.end=a.end,this.endOffset=a.endOffset}return b.prototype.normalize=function(b){var c,d,g,h,i,j,k,l,m,n,o,p,q,r;for(j={},q=["start","end"],m=0,o=q.length;o>m;m++){i=q[m];try{h=e.nodeFromXPath(this[i],b)}catch(s){throw d=s,new e.RangeError(i,"Error while finding "+i+" node: "+this[i]+": "+d,d)}if(!h)throw new e.RangeError(i,"Couldn't find "+i+" node: "+this[i]);for(g=0,k=this[i+"Offset"],"end"===i&&k--,r=f.getTextNodes(a(h)),n=0,p=r.length;p>n;n++){if(l=r[n],g+l.nodeValue.length>k){j[i+"Container"]=l,j[i+"Offset"]=this[i+"Offset"]-g;break}g+=l.nodeValue.length}if(null==j[i+"Offset"])throw new e.RangeError(""+i+"offset","Couldn't find offset "+this[i+"Offset"]+" in element "+this[i])}return c=null==document.compareDocumentPosition?function(a,b){return a.contains(b)}:function(a,b){return 16&a.compareDocumentPosition(b)},a(j.startContainer).parents().each(function(){return c(this,j.endContainer)?(j.commonAncestorContainer=this,!1):void 0}),new e.BrowserRange(j).normalize(b)},b.prototype.serialize=function(a,b){return this.normalize(a).serialize(a,b)},b.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}},b}(),t=this.Annotator,b=function(b){function c(){return this.onDeleteAnnotation=F(this.onDeleteAnnotation,this),this.onEditAnnotation=F(this.onEditAnnotation,this),this.onAdderClick=F(this.onAdderClick,this),this.onAdderMousedown=F(this.onAdderMousedown,this),this.onHighlightMouseover=F(this.onHighlightMouseover,this),this.checkForEndSelection=F(this.checkForEndSelection,this),this.checkForStartSelection=F(this.checkForStartSelection,this),this.clearViewerHideTimer=F(this.clearViewerHideTimer,this),this.startViewerHideTimer=F(this.startViewerHideTimer,this),this.showViewer=F(this.showViewer,this),this.onEditorSubmit=F(this.onEditorSubmit,this),this.onEditorHide=F(this.onEditorHide,this),this.showEditor=F(this.showEditor,this),c.__super__.constructor.apply(this,arguments),this.plugins={},c.supported()?(this.options.readOnly||this._setupDocumentEvents(),this._setupWrapper()._setupViewer()._setupEditor(),this._setupDynamicStyle(),this.adder=a(this.html.adder).appendTo(this.wrapper).hide(),void c._instances.push(this)):this}return E(c,b),c.prototype.events={".annotator-adder button click":"onAdderClick",".annotator-adder button mousedown":"onAdderMousedown",".annotator-hl mouseover":"onHighlightMouseover",".annotator-hl mouseout":"startViewerHideTimer"},c.prototype.html={adder:'<div class="annotator-adder"><button>'+B("Annotate")+"</button></div>",wrapper:'<div class="annotator-wrapper"></div>'},c.prototype.options={readOnly:!1},c.prototype.plugins={},c.prototype.editor=null,c.prototype.viewer=null,c.prototype.selectedRanges=null,c.prototype.mouseIsDown=!1,c.prototype.ignoreMouseup=!1,c.prototype.viewerHideTimer=null,c.prototype._setupWrapper=function(){return this.wrapper=a(this.html.wrapper),this.element.find("script").remove(),this.element.wrapInner(this.wrapper),this.wrapper=this.element.find(".annotator-wrapper"),this},c.prototype._setupViewer=function(){return this.viewer=new c.Viewer({readOnly:this.options.readOnly}),this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:function(b){return function(c,d){return a(c).html(d.text?f.escape(d.text):"<i>"+B("No Comment")+"</i>"),b.publish("annotationViewerTextField",[c,d])}}(this)}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer}),this},c.prototype._setupEditor=function(){return this.editor=new c.Editor,this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:B("Comments")+"â€¦",load:function(b,c){return a(b).find("textarea").val(c.text||"")},submit:function(b,c){return c.text=a(b).find("textarea").val()}}),this.editor.element.appendTo(this.wrapper),this},c.prototype._setupDocumentEvents=function(){return a(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),this},c.prototype._setupDynamicStyle=function(){var b,c,d,e;return d=a("#annotator-dynamic-style"),d.length||(d=a('<style id="annotator-dynamic-style"></style>').appendTo(document.head)),c="*"+function(){var a,b,c,d;for(c=["adder","outer","notice","filter"],d=[],a=0,b=c.length;b>a;a++)e=c[a],d.push(":not(.annotator-"+e+")");return d}().join(""),b=f.maxZIndex(a(document.body).find(c)),b=Math.max(b,1e3),d.text([".annotator-adder, .annotator-outer, .annotator-notice {","  z-index: "+(b+20)+";","}",".annotator-filter {","  z-index: "+(b+10)+";","}"].join("\n")),this},c.prototype.destroy=function(){var b,d,e,f;a(document).unbind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),a("#annotator-dynamic-style").remove(),this.adder.remove(),this.viewer.destroy(),this.editor.destroy(),this.wrapper.find(".annotator-hl").each(function(){return a(this).contents().insertBefore(this),a(this).remove()}),this.wrapper.contents().insertBefore(this.wrapper),this.wrapper.remove(),this.element.data("annotator",null),f=this.plugins;for(d in f)e=f[d],this.plugins[d].destroy();return this.removeEvents(),b=c._instances.indexOf(this),-1!==b?c._instances.splice(b,1):void 0},c.prototype.getSelectedRanges=function(){var b,c,d,g,h,i,j,k,l;for(j=f.getGlobal().getSelection(),h=[],i=[],j.isCollapsed||(h=function(){var a,f,h;for(h=[],c=a=0,f=j.rangeCount;f>=0?f>a:a>f;c=f>=0?++a:--a)g=j.getRangeAt(c),b=new e.BrowserRange(g),d=b.normalize().limit(this.wrapper[0]),null===d&&i.push(g),h.push(d);return h}.call(this),j.removeAllRanges()),k=0,l=i.length;l>k;k++)g=i[k],j.addRange(g);return a.grep(h,function(a){return a&&j.addRange(a.toRange()),a})},c.prototype.createAnnotation=function(){var a;return a={},this.publish("beforeAnnotationCreated",[a]),a},c.prototype.setupAnnotation=function(b){var c,d,f,g,h,i,j,k,l,m;for(h=this.wrapper[0],b.ranges||(b.ranges=this.selectedRanges),f=[],m=b.ranges,i=0,k=m.length;k>i;i++){g=m[i];try{f.push(e.sniff(g).normalize(h))}catch(n){if(c=n,!(c instanceof e.RangeError))throw c;this.publish("rangeNormalizeFail",[b,g,c])}}for(b.quote=[],b.ranges=[],b.highlights=[],j=0,l=f.length;l>j;j++)d=f[j],b.quote.push(a.trim(d.text())),b.ranges.push(d.serialize(this.wrapper[0],".annotator-hl")),a.merge(b.highlights,this.highlightRange(d));return b.quote=b.quote.join(" / "),a(b.highlights).data("annotation",b),b},c.prototype.updateAnnotation=function(a){return this.publish("beforeAnnotationUpdated",[a]),this.publish("annotationUpdated",[a]),a},c.prototype.deleteAnnotation=function(b){var c,d,e,f,g;if(null!=b.highlights)for(g=b.highlights,e=0,f=g.length;f>e;e++)d=g[e],null!=d.parentNode&&(c=d.childNodes[0],a(d).replaceWith(d.childNodes));return this.publish("annotationDeleted",[b]),b},c.prototype.loadAnnotations=function(a){var b,c;return null==a&&(a=[]),c=function(a){return function(d){var e,f,g,h;for(null==d&&(d=[]),f=d.splice(0,10),g=0,h=f.length;h>g;g++)e=f[g],a.setupAnnotation(e);return d.length>0?setTimeout(function(){return c(d)},10):a.publish("annotationsLoaded",[b])}}(this),b=a.slice(),c(a),this},c.prototype.dumpAnnotations=function(){return this.plugins.Store?this.plugins.Store.dumpAnnotations():(console.warn(B("Can't dump annotations without Store plugin.")),!1)},c.prototype.highlightRange=function(b,c){var d,e,f,g,h,i,j;for(null==c&&(c="annotator-hl"),f=/^\s*$/,d=a("<span class='"+c+"'></span>"),i=b.textNodes(),j=[],g=0,h=i.length;h>g;g++)e=i[g],f.test(e.nodeValue)||j.push(a(e).wrapAll(d).parent().show()[0]);return j},c.prototype.highlightRanges=function(b,c){var d,e,f,g;for(null==c&&(c="annotator-hl"),d=[],f=0,g=b.length;g>f;f++)e=b[f],a.merge(d,this.highlightRange(e,c));return d},c.prototype.addPlugin=function(a,b){var d,e;return this.plugins[a]?console.error(B("You cannot have more than one instance of any plugin.")):(d=c.Plugin[a],"function"==typeof d?(this.plugins[a]=new d(this.element[0],b),this.plugins[a].annotator=this,"function"==typeof(e=this.plugins[a]).pluginInit&&e.pluginInit()):console.error(B("Could not load ")+a+B(" plugin. Have you included the appropriate <script> tag?"))),this},c.prototype.showEditor=function(a,b){return this.editor.element.css(b),this.editor.load(a),this.publish("annotationEditorShown",[this.editor,a]),this},c.prototype.onEditorHide=function(){return this.publish("annotationEditorHidden",[this.editor]),this.ignoreMouseup=!1},c.prototype.onEditorSubmit=function(a){return this.publish("annotationEditorSubmit",[this.editor,a])},c.prototype.showViewer=function(a,b){return this.viewer.element.css(b),this.viewer.load(a),this.publish("annotationViewerShown",[this.viewer,a])},c.prototype.startViewerHideTimer=function(){return this.viewerHideTimer?void 0:this.viewerHideTimer=setTimeout(this.viewer.hide,250)},c.prototype.clearViewerHideTimer=function(){return clearTimeout(this.viewerHideTimer),this.viewerHideTimer=!1},c.prototype.checkForStartSelection=function(a){return a&&this.isAnnotator(a.target)||this.startViewerHideTimer(),this.mouseIsDown=!0},c.prototype.checkForEndSelection=function(b){var c,d,e,g,h;if(this.mouseIsDown=!1,!this.ignoreMouseup){for(this.selectedRanges=this.getSelectedRanges(),h=this.selectedRanges,e=0,g=h.length;g>e;e++)if(d=h[e],c=d.commonAncestor,a(c).hasClass("annotator-hl")&&(c=a(c).parents("[class!=annotator-hl]")[0]),this.isAnnotator(c))return;return b&&this.selectedRanges.length?this.adder.css(f.mousePosition(b,this.wrapper[0])).show():this.adder.hide()}},c.prototype.isAnnotator=function(b){return!!a(b).parents().addBack().filter("[class^=annotator-]").not(this.wrapper).length},c.prototype.onHighlightMouseover=function(b){var c;return this.clearViewerHideTimer(),this.mouseIsDown||this.viewer.isShown()?!1:(c=a(b.target).parents(".annotator-hl").addBack().map(function(){return a(this).data("annotation")}),this.showViewer(a.makeArray(c),f.mousePosition(b,this.wrapper[0])))},c.prototype.onAdderMousedown=function(a){return null!=a&&a.preventDefault(),this.ignoreMouseup=!0},c.prototype.onAdderClick=function(b){var c,d,e,f,g;return null!=b&&b.preventDefault(),f=this.adder.position(),this.adder.hide(),c=this.setupAnnotation(this.createAnnotation()),a(c.highlights).addClass("annotator-hl-temporary"),g=function(b){return function(){return e(),a(c.highlights).removeClass("annotator-hl-temporary"),b.publish("annotationCreated",[c])}}(this),d=function(a){return function(){return e(),a.deleteAnnotation(c)}}(this),e=function(a){return function(){return a.unsubscribe("annotationEditorHidden",d),a.unsubscribe("annotationEditorSubmit",g)}}(this),this.subscribe("annotationEditorHidden",d),this.subscribe("annotationEditorSubmit",g),this.showEditor(c,f)},c.prototype.onEditAnnotation=function(a){var b,c,d;return c=this.viewer.element.position(),d=function(c){return function(){return b(),c.updateAnnotation(a)}}(this),b=function(a){return function(){return a.unsubscribe("annotationEditorHidden",b),a.unsubscribe("annotationEditorSubmit",d)}}(this),this.subscribe("annotationEditorHidden",b),this.subscribe("annotationEditorSubmit",d),this.viewer.hide(),this.showEditor(a,c)},c.prototype.onDeleteAnnotation=function(a){return this.viewer.hide(),this.deleteAnnotation(a)},c}(c),b.Plugin=function(a){function b(){b.__super__.constructor.apply(this,arguments)}return E(b,a),b.prototype.pluginInit=function(){},b.prototype.destroy=function(){return this.removeEvents()},b}(c),m=f.getGlobal(),null==(null!=(A=m.document)?A.evaluate:void 0)&&a.getScript("http://assets.annotateit.org/vendor/xpath.min.js"),null==m.getSelection&&a.getScript("http://assets.annotateit.org/vendor/ierange.min.js"),null==m.JSON&&a.getScript("http://assets.annotateit.org/vendor/json2.min.js"),null==m.Node&&(m.Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12}),b.$=a,b.Delegator=c,b.Range=e,b.Util=f,b._instances=[],b._t=B,b.supported=function(){return function(){return!!this.getSelection}()},b.noConflict=function(){return f.getGlobal().Annotator=t,this},a.fn.annotator=function(c){var d;return d=Array.prototype.slice.call(arguments,1),this.each(function(){var e;return e=a.data(this,"annotator"),e?c&&e[c].apply(e,d):(e=new b(this,c),a.data(this,"annotator",e))})},this.Annotator=b,b.Widget=function(c){function d(){d.__super__.constructor.apply(this,arguments),this.classes=a.extend({},b.Widget.prototype.classes,this.classes)}return E(d,c),d.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}},d.prototype.destroy=function(){return this.removeEvents(),this.element.remove()},d.prototype.checkOrientation=function(){var c,d,e,f,g;return this.resetOrientation(),g=a(b.Util.getGlobal()),f=this.element.children(":first"),d=f.offset(),e={top:g.scrollTop(),right:g.width()+g.scrollLeft()},c={top:d.top,right:d.left+f.width()},c.top-e.top<0&&this.invertY(),c.right-e.right>0&&this.invertX(),this},d.prototype.resetOrientation=function(){return this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y),this},d.prototype.invertX=function(){return this.element.addClass(this.classes.invert.x),this},d.prototype.invertY=function(){return this.element.addClass(this.classes.invert.y),this},d.prototype.isInvertedY=function(){return this.element.hasClass(this.classes.invert.y)},d.prototype.isInvertedX=function(){return this.element.hasClass(this.classes.invert.x)},d}(c),b.Editor=function(c){function d(b){this.onCancelButtonMouseover=F(this.onCancelButtonMouseover,this),this.processKeypress=F(this.processKeypress,this),this.submit=F(this.submit,this),this.load=F(this.load,this),this.hide=F(this.hide,this),this.show=F(this.show,this),d.__super__.constructor.call(this,a(this.html)[0],b),this.fields=[],this.annotation={}}return E(d,c),d.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress"},d.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"},d.prototype.html='<div class="annotator-outer annotator-editor">\n  <form class="annotator-widget">\n    <ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">'+B("Cancel")+'</a>\n<a href="#save" class="annotator-save annotator-focus">'+B("Save")+"</a>\n    </div>\n  </form>\n</div>",d.prototype.options={},d.prototype.show=function(a){return b.Util.preventEventDefault(a),this.element.removeClass(this.classes.hide),this.element.find(".annotator-save").addClass(this.classes.focus),this.checkOrientation(),this.element.find(":input:first").focus(),this.setupDraggables(),this.publish("show")},d.prototype.hide=function(a){return b.Util.preventEventDefault(a),this.element.addClass(this.classes.hide),this.publish("hide")},d.prototype.load=function(a){var b,c,d,e;for(this.annotation=a,this.publish("load",[this.annotation]),e=this.fields,c=0,d=e.length;d>c;c++)b=e[c],b.load(b.element,this.annotation);return this.show()},d.prototype.submit=function(a){var c,d,e,f;for(b.Util.preventEventDefault(a),f=this.fields,d=0,e=f.length;e>d;d++)c=f[d],c.submit(c.element,this.annotation);return this.publish("save",[this.annotation]),this.hide()},d.prototype.addField=function(c){var d,e,f;switch(e=a.extend({id:"annotator-field-"+b.Util.uuid(),type:"input",label:"",load:function(){},submit:function(){}},c),f=null,d=a('<li class="annotator-item" />'),e.element=d[0],e.type){case"textarea":f=a("<textarea />");break;case"input":case"checkbox":f=a("<input />");break;case"select":f=a("<select />")}return d.append(f),f.attr({id:e.id,placeholder:e.label}),"checkbox"===e.type&&(f[0].type="checkbox",d.addClass("annotator-checkbox"),d.append(a("<label />",{"for":e.id,html:e.label}))),this.element.find("ul:first").append(d),this.fields.push(e),e.element},d.prototype.checkOrientation=function(){var a,b;return d.__super__.checkOrientation.apply(this,arguments),b=this.element.find("ul"),a=this.element.find(".annotator-controls"),this.element.hasClass(this.classes.invert.y)?a.insertBefore(b):a.is(":first-child")&&a.insertAfter(b),this},d.prototype.processKeypress=function(a){return 27===a.keyCode?this.hide():13!==a.keyCode||a.shiftKey?void 0:this.submit()},d.prototype.onCancelButtonMouseover=function(){return this.element.find("."+this.classes.focus).removeClass(this.classes.focus)},d.prototype.setupDraggables=function(){var b,c,d,e,f,g,h,i,j,k,l;return this.element.find(".annotator-resize").remove(),d=this.element.find(this.element.hasClass(this.classes.invert.y)?".annotator-item:last":".annotator-item:first"),d&&a('<span class="annotator-resize"></span>').appendTo(d),f=null,b=this.classes,e=this.element,k=null,j=e.find(".annotator-resize"),c=e.find(".annotator-controls"),l=!1,g=function(b){return b.target===this?(f={element:this,top:b.pageY,left:b.pageX},k=e.find("textarea:first"),a(window).bind({"mouseup.annotator-editor-resize":i,"mousemove.annotator-editor-resize":h}),b.preventDefault()):void 0},i=function(){return f=null,a(window).unbind(".annotator-editor-resize")},h=function(){return function(a){var d,g,h,i,m;return f&&l===!1?(d={top:a.pageY-f.top,left:a.pageX-f.left},f.element===j[0]?(i=k.outerHeight(),m=k.outerWidth(),g=e.hasClass(b.invert.x)?-1:1,h=e.hasClass(b.invert.y)?1:-1,k.height(i+d.top*h),k.width(m+d.left*g),k.outerHeight()!==i&&(f.top=a.pageY),k.outerWidth()!==m&&(f.left=a.pageX)):f.element===c[0]&&(e.css({top:parseInt(e.css("top"),10)+d.top,left:parseInt(e.css("left"),10)+d.left}),f.top=a.pageY,f.left=a.pageX),l=!0,setTimeout(function(){return l=!1},1e3/60)):void 0}}(this),j.bind("mousedown",g),c.bind("mousedown",g)},d}(b.Widget),b.Viewer=function(c){function e(b){this.onDeleteClick=F(this.onDeleteClick,this),this.onEditClick=F(this.onEditClick,this),this.load=F(this.load,this),this.hide=F(this.hide,this),this.show=F(this.show,this),e.__super__.constructor.call(this,a(this.html.element)[0],b),this.item=a(this.html.item)[0],this.fields=[],this.annotations=[]}return E(e,c),e.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"},e.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"},e.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <a href="#" title="View as webpage" class="annotator-link">View as webpage</a>\n    <button title="Edit" class="annotator-edit">Edit</button>\n    <button title="Delete" class="annotator-delete">Delete</button>\n  </span>\n</li>'},e.prototype.options={readOnly:!1},e.prototype.show=function(a){var c;return b.Util.preventEventDefault(a),c=this.element.find(".annotator-controls").addClass(this.classes.showControls),setTimeout(function(a){return function(){return c.removeClass(a.classes.showControls)}}(this),500),this.element.removeClass(this.classes.hide),this.checkOrientation().publish("show")},e.prototype.isShown=function(){return!this.element.hasClass(this.classes.hide)},e.prototype.hide=function(a){return b.Util.preventEventDefault(a),this.element.addClass(this.classes.hide),this.publish("hide")},e.prototype.load=function(b){var c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;for(this.annotations=b||[],n=this.element.find("ul:first").empty(),s=this.annotations,o=0,q=s.length;q>o;o++)for(c=s[o],k=a(this.item).clone().appendTo(n).data("annotation",c),f=k.find(".annotator-controls"),l=f.find(".annotator-link"),h=f.find(".annotator-edit"),g=f.find(".annotator-delete"),m=new d(c.links||[]).get("alternate",{type:"text/html"}),0===m.length||null==m[0].href?l.remove():l.attr("href",m[0].href),this.options.readOnly?(h.remove(),g.remove()):e={showEdit:function(){return h.removeAttr("disabled")},hideEdit:function(){return h.attr("disabled","disabled")},showDelete:function(){return g.removeAttr("disabled")},hideDelete:function(){return g.attr("disabled","disabled")}},t=this.fields,p=0,r=t.length;r>p;p++)j=t[p],i=a(j.element).clone().appendTo(k)[0],j.load(i,c,e);return this.publish("load",[this.annotations]),this.show()
},e.prototype.addField=function(b){var c;return c=a.extend({load:function(){}},b),c.element=a("<div />")[0],this.fields.push(c),c.element,this},e.prototype.onEditClick=function(a){return this.onButtonClick(a,"edit")},e.prototype.onDeleteClick=function(a){return this.onButtonClick(a,"delete")},e.prototype.onButtonClick=function(b,c){var d;return d=a(b.target).parents(".annotator-annotation"),this.publish(c,[d.data("annotation")])},e}(b.Widget),d=function(){function b(a){this.data=a}return b.prototype.get=function(b,c){var d,e,f,g,h,i,j,k,l;for(null==c&&(c={}),c=a.extend({},c,{rel:b}),f=function(){var a;a=[];for(e in c)D.call(c,e)&&(h=c[e],a.push(e));return a}(),k=this.data,l=[],i=0,j=k.length;j>i;i++)d=k[i],g=f.reduce(function(a,b){return a&&d[b]===c[b]},!0),g&&l.push(d);return l},b}(),b=b||{},b.Notification=function(c){function d(b){this.hide=F(this.hide,this),this.show=F(this.show,this),d.__super__.constructor.call(this,a(this.options.html).appendTo(document.body)[0],b)}return E(d,c),d.prototype.events={click:"hide"},d.prototype.options={html:"<div class='annotator-notice'></div>",classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}},d.prototype.show=function(c,d){return null==d&&(d=b.Notification.INFO),this.currentStatus=d,a(this.element).addClass(this.options.classes.show).addClass(this.options.classes[this.currentStatus]).html(f.escape(c||"")),setTimeout(this.hide,5e3),this},d.prototype.hide=function(){return null==this.currentStatus&&(this.currentStatus=b.Notification.INFO),a(this.element).removeClass(this.options.classes.show).removeClass(this.options.classes[this.currentStatus]),this},d}(c),b.Notification.INFO="info",b.Notification.SUCCESS="success",b.Notification.ERROR="error",a(function(){var a;return a=new b.Notification,b.showNotification=a.show,b.hideNotification=a.hide}),b.Plugin.Unsupported=function(c){function d(){return d.__super__.constructor.apply(this,arguments)}return E(d,c),d.prototype.options={message:b._t("Sorry your current browser does not support the Annotator")},d.prototype.pluginInit=function(){return b.supported()?void 0:a(function(c){return function(){return b.showNotification(c.options.message),void 0===window.XMLHttpRequest&&void 0!==ActiveXObject?a("html").addClass("ie6"):void 0}}(this))},d}(b.Plugin),i=function(a){var b,c,d,e,f,g;return e="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\\.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?",b=a.match(new RegExp(e)),d=0,c=new Date(b[1],0,1),b[3]&&c.setMonth(b[3]-1),b[5]&&c.setDate(b[5]),b[7]&&c.setHours(b[7]),b[8]&&c.setMinutes(b[8]),b[10]&&c.setSeconds(b[10]),b[12]&&c.setMilliseconds(1e3*Number("0."+b[12])),b[14]&&(d=60*Number(b[16])+Number(b[17]),d*=null!=(g="-"===b[15])?g:{1:-1}),d-=c.getTimezoneOffset(),f=Number(c)+60*d*1e3,c.setTime(Number(f)),c},g=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;if("undefined"!=typeof atob&&null!==atob)return atob(a);if(c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",j=0,b=0,e="",n=[],!a)return a;for(a+="";j<a.length;)f=c.indexOf(a.charAt(j++)),g=c.indexOf(a.charAt(j++)),h=c.indexOf(a.charAt(j++)),i=c.indexOf(a.charAt(j++)),d=f<<18|g<<12|h<<6|i,k=d>>16&255,l=d>>8&255,m=255&d,n[b++]=64===h?String.fromCharCode(k):64===i?String.fromCharCode(k,l):String.fromCharCode(k,l,m);return n.join("")},h=function(a){var b,c,d,e;if(c=a.length%4,0!==c)for(b=d=0,e=4-c;e>=0?e>d:d>e;b=e>=0?++d:--d)a+="=";return a=a.replace(/-/g,"+"),a=a.replace(/_/g,"/"),g(a)},q=function(a){var b,c,d,e;return e=a.split("."),b=e[0],c=e[1],d=e[2],JSON.parse(h(c))},b.Plugin.Auth=function(c){function d(){d.__super__.constructor.apply(this,arguments),this.waitingForToken=[],this.options.token?this.setToken(this.options.token):this.requestToken()}return E(d,c),d.prototype.options={token:null,tokenUrl:"/auth/token",autoFetch:!0},d.prototype.requestToken=function(){return this.requestInProgress=!0,a.ajax({url:this.options.tokenUrl,dataType:"text",xhrFields:{withCredentials:!0}}).done(function(a){return function(b){return a.setToken(b)}}(this)).fail(function(){return function(a,c,d){var e;return e=b._t("Couldn't get auth token:"),console.error(""+e+" "+d,a),b.showNotification(""+e+" "+a.responseText,b.Notification.ERROR)}}(this)).always(function(a){return function(){return a.requestInProgress=!1}}(this))},d.prototype.setToken=function(a){var c;if(this.token=a,this._unsafeToken=q(a),this.haveValidToken()){for(this.options.autoFetch&&(this.refreshTimeout=setTimeout(function(a){return function(){return a.requestToken()}}(this),1e3*(this.timeToExpiry()-2))),this.updateHeaders(),c=[];this.waitingForToken.length>0;)c.push(this.waitingForToken.pop()(this._unsafeToken));return c}return console.warn(b._t("Didn't get a valid token.")),this.options.autoFetch?(console.warn(b._t("Getting a new token in 10s.")),setTimeout(function(a){return function(){return a.requestToken()}}(this),1e4)):void 0},d.prototype.haveValidToken=function(){var a;return a=this._unsafeToken&&this._unsafeToken.issuedAt&&this._unsafeToken.ttl&&this._unsafeToken.consumerKey,a&&this.timeToExpiry()>0?!0:!1},d.prototype.timeToExpiry=function(){var a,b,c,d;return c=(new Date).getTime()/1e3,b=i(this._unsafeToken.issuedAt).getTime()/1e3,a=b+this._unsafeToken.ttl,d=a-c,d>0?d:0},d.prototype.updateHeaders=function(){var b;return b=this.element.data("annotator:headers"),this.element.data("annotator:headers",a.extend(b,{"x-annotator-auth-token":this.token}))},d.prototype.withToken=function(a){return null!=a?this.haveValidToken()?a(this._unsafeToken):(this.waitingForToken.push(a),this.requestInProgress?void 0:this.requestToken()):void 0},d}(b.Plugin),b.Plugin.Store=function(c){function d(){this._onError=F(this._onError,this),this._onLoadAnnotationsFromSearch=F(this._onLoadAnnotationsFromSearch,this),this._onLoadAnnotations=F(this._onLoadAnnotations,this),this._getAnnotations=F(this._getAnnotations,this),d.__super__.constructor.apply(this,arguments),this.annotations=[]}return E(d,c),d.prototype.events={annotationCreated:"annotationCreated",annotationDeleted:"annotationDeleted",annotationUpdated:"annotationUpdated"},d.prototype.options={annotationData:{},emulateHTTP:!1,loadFromSearch:!1,prefix:"/store",urls:{create:"/annotations",read:"/annotations/:id",update:"/annotations/:id",destroy:"/annotations/:id",search:"/search"}},d.prototype.pluginInit=function(){return b.supported()?this.annotator.plugins.Auth?this.annotator.plugins.Auth.withToken(this._getAnnotations):this._getAnnotations():void 0},d.prototype._getAnnotations=function(){return this.options.loadFromSearch?this.loadAnnotationsFromSearch(this.options.loadFromSearch):this.loadAnnotations()},d.prototype.annotationCreated=function(a){return G.call(this.annotations,a)<0?(this.registerAnnotation(a),this._apiRequest("create",a,function(c){return function(d){return null==d.id&&console.warn(b._t("Warning: No ID returned from server for annotation "),a),c.updateAnnotation(a,d)}}(this))):this.updateAnnotation(a,{})},d.prototype.annotationUpdated=function(a){return G.call(this.annotations,a)>=0?this._apiRequest("update",a,function(b){return function(c){return b.updateAnnotation(a,c)}}(this)):void 0},d.prototype.annotationDeleted=function(a){return G.call(this.annotations,a)>=0?this._apiRequest("destroy",a,function(b){return function(){return b.unregisterAnnotation(a)}}(this)):void 0},d.prototype.registerAnnotation=function(a){return this.annotations.push(a)},d.prototype.unregisterAnnotation=function(a){return this.annotations.splice(this.annotations.indexOf(a),1)},d.prototype.updateAnnotation=function(c,d){return G.call(this.annotations,c)<0?console.error(b._t("Trying to update unregistered annotation!")):a.extend(c,d),a(c.highlights).data("annotation",c)},d.prototype.loadAnnotations=function(){return this._apiRequest("read",null,this._onLoadAnnotations)},d.prototype._onLoadAnnotations=function(a){var b,c,d,e,f,g,h,i,j;for(null==a&&(a=[]),d={},j=this.annotations,f=0,h=j.length;h>f;f++)b=j[f],d[b.id]=b;for(e=[],g=0,i=a.length;i>g;g++)b=a[g],d[b.id]?(c=d[b.id],this.updateAnnotation(c,b)):e.push(b);return this.annotations=this.annotations.concat(e),this.annotator.loadAnnotations(e.slice())},d.prototype.loadAnnotationsFromSearch=function(a){return this._apiRequest("search",a,this._onLoadAnnotationsFromSearch)},d.prototype._onLoadAnnotationsFromSearch=function(a){return null==a&&(a={}),this._onLoadAnnotations(a.rows||[])},d.prototype.dumpAnnotations=function(){var a,b,c,d,e;for(d=this.annotations,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(JSON.parse(this._dataFor(a)));return e},d.prototype._apiRequest=function(b,c,d){var e,f,g,h;return e=c&&c.id,h=this._urlFor(b,e),f=this._apiRequestOptions(b,c,d),g=a.ajax(h,f),g._id=e,g._action=b,g},d.prototype._apiRequestOptions=function(b,c,d){var e,f,g;return f=this._methodFor(b),g={type:f,headers:this.element.data("annotator:headers"),dataType:"json",success:d||function(){},error:this._onError},!this.options.emulateHTTP||"PUT"!==f&&"DELETE"!==f||(g.headers=a.extend(g.headers,{"X-HTTP-Method-Override":f}),g.type="POST"),"search"===b?g=a.extend(g,{data:c}):(e=c&&this._dataFor(c),this.options.emulateJSON?(g.data={json:e},this.options.emulateHTTP&&(g.data._method=f),g):g=a.extend(g,{data:e,contentType:"application/json; charset=utf-8"}))},d.prototype._urlFor=function(a,b){var c;return c=null!=this.options.prefix?this.options.prefix:"",c+=this.options.urls[a],c=c.replace(/\/:id/,null!=b?"/"+b:""),c=c.replace(/:id/,null!=b?b:"")},d.prototype._methodFor=function(a){var b;return b={create:"POST",read:"GET",update:"PUT",destroy:"DELETE",search:"GET"},b[a]},d.prototype._dataFor=function(b){var c,d;return d=b.highlights,delete b.highlights,a.extend(b,this.options.annotationData),c=JSON.stringify(b),d&&(b.highlights=d),c},d.prototype._onError=function(a){var c,d;switch(c=a._action,d=b._t("Sorry we could not ")+c+b._t(" this annotation"),"search"===a._action?d=b._t("Sorry we could not search the store for annotations"):"read"!==a._action||a._id||(d=b._t("Sorry we could not ")+c+b._t(" the annotations from the store")),a.status){case 401:d=b._t("Sorry you are not allowed to ")+c+b._t(" this annotation");break;case 404:d=b._t("Sorry we could not connect to the annotations store");break;case 500:d=b._t("Sorry something went wrong with the annotation store")}return b.showNotification(d,b.Notification.ERROR),console.error(b._t("API request failed:")+(" '"+a.status+"'"))},d}(b.Plugin),b.Plugin.Permissions=function(c){function d(){this._setAuthFromToken=F(this._setAuthFromToken,this),this.updateViewer=F(this.updateViewer,this),this.updateAnnotationPermissions=F(this.updateAnnotationPermissions,this),this.updatePermissionsField=F(this.updatePermissionsField,this),this.addFieldsToAnnotation=F(this.addFieldsToAnnotation,this),d.__super__.constructor.apply(this,arguments),this.options.user&&(this.setUser(this.options.user),delete this.options.user)}return E(d,c),d.prototype.events={beforeAnnotationCreated:"addFieldsToAnnotation"},d.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,userId:function(a){return a},userString:function(a){return a},userAuthorize:function(a,b,c){var d,e,f,g;if(b.permissions){if(e=b.permissions[a]||[],0===e.length)return!0;for(f=0,g=e.length;g>f;f++)if(d=e[f],this.userId(c)===d)return!0;return!1}return b.user?c?this.userId(c)===this.userId(b.user):!1:!0},user:"",permissions:{read:[],update:[],"delete":[],admin:[]}},d.prototype.pluginInit=function(){var a,c;if(b.supported())return c=this,a=function(a,b){return function(d,e){return c[a].call(c,b,d,e)}},!this.user&&this.annotator.plugins.Auth&&this.annotator.plugins.Auth.withToken(this._setAuthFromToken),this.options.showViewPermissionsCheckbox===!0&&this.annotator.editor.addField({type:"checkbox",label:b._t("Allow anyone to <strong>view</strong> this annotation"),load:a("updatePermissionsField","read"),submit:a("updateAnnotationPermissions","read")}),this.options.showEditPermissionsCheckbox===!0&&this.annotator.editor.addField({type:"checkbox",label:b._t("Allow anyone to <strong>edit</strong> this annotation"),load:a("updatePermissionsField","update"),submit:a("updateAnnotationPermissions","update")}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter?this.annotator.plugins.Filter.addFilter({label:b._t("User"),property:"user",isFiltered:function(a){return function(b,c){var d,e,f,g;if(c=a.options.userString(c),!b||!c)return!1;for(g=b.split(/\s*/),e=0,f=g.length;f>e;e++)if(d=g[e],-1===c.indexOf(d))return!1;return!0}}(this)}):void 0},d.prototype.setUser=function(a){return this.user=a},d.prototype.addFieldsToAnnotation=function(a){return a&&(a.permissions=this.options.permissions,this.user)?a.user=this.user:void 0},d.prototype.authorize=function(a,b,c){return void 0===c&&(c=this.user),this.options.userAuthorize?this.options.userAuthorize.call(this.options,a,b,c):!0},d.prototype.updatePermissionsField=function(b,c,d){var e;return c=a(c).show(),e=c.find("input").removeAttr("disabled"),this.authorize("admin",d)||c.hide(),this.authorize(b,d||{},null)?e.attr("checked","checked"):e.removeAttr("checked")},d.prototype.updateAnnotationPermissions=function(b,c,d){var e;return d.permissions||(d.permissions=this.options.permissions),e=b+"-permissions",d.permissions[b]=a(c).find("input").is(":checked")?[]:[this.options.userId(this.user)]},d.prototype.updateViewer=function(c,d,e){var f,g;return c=a(c),g=this.options.userString(d.user),d.user&&g&&"string"==typeof g?(f=b.Util.escape(this.options.userString(d.user)),c.html(f).addClass("annotator-user")):c.remove(),e&&(this.authorize("update",d)||e.hideEdit(),!this.authorize("delete",d))?e.hideDelete():void 0},d.prototype._setAuthFromToken=function(a){return this.setUser(a.userId)},d}(b.Plugin),b.Plugin.AnnotateItPermissions=function(b){function c(){return this._setAuthFromToken=F(this._setAuthFromToken,this),this.updateAnnotationPermissions=F(this.updateAnnotationPermissions,this),this.updatePermissionsField=F(this.updatePermissionsField,this),this.addFieldsToAnnotation=F(this.addFieldsToAnnotation,this),c.__super__.constructor.apply(this,arguments)}return E(c,b),c.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,groups:{world:"group:__world__",authenticated:"group:__authenticated__",consumer:"group:__consumer__"},userId:function(a){return a.userId},userString:function(a){return a.userId},userAuthorize:function(a,b,c){var d,e,f,g,h,i;return e=b.permissions||{},d=e[a]||[],f=this.groups.world,G.call(d,f)>=0?!0:null!=c&&null!=c.userId&&null!=c.consumerKey?c.userId===b.user&&c.consumerKey===b.consumer?!0:(g=this.groups.authenticated,G.call(d,g)>=0?!0:c.consumerKey===b.consumer&&(h=this.groups.consumer,G.call(d,h)>=0)?!0:c.consumerKey===b.consumer&&(i=c.userId,G.call(d,i)>=0)?!0:c.consumerKey===b.consumer&&c.admin?!0:!1):!1},permissions:{read:["group:__world__"],update:[],"delete":[],admin:[]}},c.prototype.addFieldsToAnnotation=function(a){return a&&(a.permissions=this.options.permissions,this.user)?(a.user=this.user.userId,a.consumer=this.user.consumerKey):void 0},c.prototype.updatePermissionsField=function(b,c,d){var e;return c=a(c).show(),e=c.find("input").removeAttr("disabled"),this.authorize("admin",d)||c.hide(),this.user&&this.authorize(b,d||{},{userId:"__nonexistentuser__",consumerKey:this.user.consumerKey})?e.attr("checked","checked"):e.removeAttr("checked")},c.prototype.updateAnnotationPermissions=function(b,c,d){var e;return d.permissions||(d.permissions=this.options.permissions),e=b+"-permissions",d.permissions[b]=a(c).find("input").is(":checked")?["read"===b?this.options.groups.world:this.options.groups.consumer]:[]},c.prototype._setAuthFromToken=function(a){return this.setUser(a)},c}(b.Plugin.Permissions),b.Plugin.Filter=function(c){function d(b,c){this._onPreviousClick=F(this._onPreviousClick,this),this._onNextClick=F(this._onNextClick,this),this._onFilterKeyup=F(this._onFilterKeyup,this),this._onFilterBlur=F(this._onFilterBlur,this),this._onFilterFocus=F(this._onFilterFocus,this),this.updateHighlights=F(this.updateHighlights,this);var e;b=a(this.html.element).appendTo((null!=c?c.appendTo:void 0)||this.options.appendTo),d.__super__.constructor.call(this,b,c),(e=this.options).filters||(e.filters=[]),this.filter=a(this.html.filter),this.filters=[],this.current=0}return E(d,c),d.prototype.events={".annotator-filter-property input focus":"_onFilterFocus",".annotator-filter-property input blur":"_onFilterBlur",".annotator-filter-property input keyup":"_onFilterKeyup",".annotator-filter-previous click":"_onPreviousClick",".annotator-filter-next click":"_onNextClick",".annotator-filter-clear click":"_onClearClick"},d.prototype.classes={active:"annotator-filter-active",hl:{hide:"annotator-hl-filtered",active:"annotator-hl-active"}},d.prototype.html={element:'<div class="annotator-filter">\n  <strong>'+b._t("Navigate:")+'</strong>\n<span class="annotator-filter-navigation">\n  <button class="annotator-filter-previous">'+b._t("Previous")+'</button>\n<button class="annotator-filter-next">'+b._t("Next")+"</button>\n</span>\n<strong>"+b._t("Filter by:")+"</strong>\n</div>",filter:'<span class="annotator-filter-property">\n  <label></label>\n  <input/>\n  <button class="annotator-filter-clear">'+b._t("Clear")+"</button>\n</span>"},d.prototype.options={appendTo:"body",filters:[],addAnnotationFilter:!0,isFiltered:function(a,b){var c,d,e,f;if(!a||!b)return!1;for(f=a.split(/\s+/),d=0,e=f.length;e>d;d++)if(c=f[d],-1===b.indexOf(c))return!1;return!0}},d.prototype.pluginInit=function(){var a,c,d,e;for(e=this.options.filters,c=0,d=e.length;d>c;c++)a=e[c],this.addFilter(a);return this.updateHighlights(),this._setupListeners()._insertSpacer(),this.options.addAnnotationFilter===!0?this.addFilter({label:b._t("Annotation"),property:"text"}):void 0},d.prototype.destroy=function(){var b,c;return d.__super__.destroy.apply(this,arguments),c=a("html"),b=parseInt(c.css("padding-top"),10)||0,c.css("padding-top",b-this.element.outerHeight()),this.element.remove()},d.prototype._insertSpacer=function(){var b,c;return c=a("html"),b=parseInt(c.css("padding-top"),10)||0,c.css("padding-top",b+this.element.outerHeight()),this},d.prototype._setupListeners=function(){var a,b,c,d;for(b=["annotationsLoaded","annotationCreated","annotationUpdated","annotationDeleted"],c=0,d=b.length;d>c;c++)a=b[c],this.annotator.subscribe(a,this.updateHighlights);return this},d.prototype.addFilter=function(c){var d,e;return e=a.extend({label:"",property:"",isFiltered:this.options.isFiltered},c),function(){var a,b,c,f;for(c=this.filters,f=[],a=0,b=c.length;b>a;a++)d=c[a],d.property===e.property&&f.push(d);return f}.call(this).length||(e.id="annotator-filter-"+e.property,e.annotations=[],e.element=this.filter.clone().appendTo(this.element),e.element.find("label").html(e.label).attr("for",e.id),e.element.find("input").attr({id:e.id,placeholder:b._t("Filter by ")+e.label+"â€¦"}),e.element.find("button").hide(),e.element.data("filter",e),this.filters.push(e)),this},d.prototype.updateFilter=function(b){var c,d,e,f,g,h,i;if(b.annotations=[],this.updateHighlights(),this.resetHighlights(),e=a.trim(b.element.find("input").val())){for(d=this.highlights.map(function(){return a(this).data("annotation")}),i=a.makeArray(d),g=0,h=i.length;h>g;g++)c=i[g],f=c[b.property],b.isFiltered(e,f)&&b.annotations.push(c);return this.filterHighlights()}},d.prototype.updateHighlights=function(){return this.highlights=this.annotator.element.find(".annotator-hl:visible"),this.filtered=this.highlights.not(this.classes.hl.hide)},d.prototype.filterHighlights=function(){var b,c,d,e,f,g,h,i,j,k;for(b=a.grep(this.filters,function(a){return!!a.annotations.length}),e=(null!=(k=b[0])?k.annotations:void 0)||[],b.length>1&&(d=[],a.each(b,function(){return a.merge(d,this.annotations)}),h=[],e=[],a.each(d,function(){return-1===a.inArray(this,h)?h.push(this):e.push(this)})),f=this.highlights,g=i=0,j=e.length;j>i;g=++i)c=e[g],f=f.not(c.highlights);return f.addClass(this.classes.hl.hide),this.filtered=this.highlights.not(this.classes.hl.hide),this},d.prototype.resetHighlights=function(){return this.highlights.removeClass(this.classes.hl.hide),this.filtered=this.highlights,this},d.prototype._onFilterFocus=function(b){var c;return c=a(b.target),c.parent().addClass(this.classes.active),c.next("button").show()},d.prototype._onFilterBlur=function(b){var c;return b.target.value?void 0:(c=a(b.target),c.parent().removeClass(this.classes.active),c.next("button").hide())},d.prototype._onFilterKeyup=function(b){var c;return c=a(b.target).parent().data("filter"),c?this.updateFilter(c):void 0},d.prototype._findNextHighlight=function(a){var b,c,d,e,f,g,h,i;return this.highlights.length?(g=a?0:-1,i=a?-1:0,h=a?"lt":"gt",b=this.highlights.not("."+this.classes.hl.hide),d=b.filter("."+this.classes.hl.active),d.length||(d=b.eq(g)),c=d.data("annotation"),e=b.index(d[0]),f=b.filter(":"+h+"("+e+")").not(c.highlights).eq(i),f.length||(f=b.eq(i)),this._scrollToHighlight(f.data("annotation").highlights)):this},d.prototype._onNextClick=function(){return this._findNextHighlight()},d.prototype._onPreviousClick=function(){return this._findNextHighlight(!0)},d.prototype._scrollToHighlight=function(b){return b=a(b),this.highlights.removeClass(this.classes.hl.active),b.addClass(this.classes.hl.active),a("html, body").animate({scrollTop:b.offset().top-(this.element.height()+20)},150)},d.prototype._onClearClick=function(b){return a(b.target).prev("input").val("").keyup().blur()},d}(b.Plugin),b.Plugin.Markdown=function(c){function d(){this.updateTextField=F(this.updateTextField,this),null!=("undefined"!=typeof Showdown&&null!==Showdown?Showdown.converter:void 0)?(d.__super__.constructor.apply(this,arguments),this.converter=new Showdown.converter):console.error(b._t("To use the Markdown plugin, you must include Showdown into the page first."))}return E(d,c),d.prototype.events={annotationViewerTextField:"updateTextField"},d.prototype.updateTextField=function(c,d){var e;return e=b.Util.escape(d.text||""),a(c).html(this.convert(e))},d.prototype.convert=function(a){return this.converter.makeHtml(a)},d}(b.Plugin),b.Plugin.Tags=function(c){function d(){return this.setAnnotationTags=F(this.setAnnotationTags,this),this.updateField=F(this.updateField,this),d.__super__.constructor.apply(this,arguments)}return E(d,c),d.prototype.options={parseTags:function(b){var c;return b=a.trim(b),c=[],b&&(c=b.split(/\s+/)),c},stringifyTags:function(a){return a.join(" ")}},d.prototype.field=null,d.prototype.input=null,d.prototype.pluginInit=function(){return b.supported()?(this.field=this.annotator.editor.addField({label:b._t("Add some tags here")+"â€¦",load:this.updateField,submit:this.setAnnotationTags}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter&&this.annotator.plugins.Filter.addFilter({label:b._t("Tag"),property:"tags",isFiltered:b.Plugin.Tags.filterCallback}),this.input=a(this.field).find(":input")):void 0},d.prototype.parseTags=function(a){return this.options.parseTags(a)},d.prototype.stringifyTags=function(a){return this.options.stringifyTags(a)},d.prototype.updateField=function(a,b){var c;return c="",b.tags&&(c=this.stringifyTags(b.tags)),this.input.val(c)},d.prototype.setAnnotationTags=function(a,b){return b.tags=this.parseTags(this.input.val())},d.prototype.updateViewer=function(c,d){return c=a(c),d.tags&&a.isArray(d.tags)&&d.tags.length?c.addClass("annotator-tags").html(function(){var c;return c=a.map(d.tags,function(a){return'<span class="annotator-tag">'+b.Util.escape(a)+"</span>"}).join(" ")}):c.remove()},d}(b.Plugin),b.Plugin.Tags.filterCallback=function(a,b){var c,d,e,f,g,h,i,j;if(null==b&&(b=[]),e=0,d=[],a)for(d=a.split(/\s+/g),g=0,i=d.length;i>g;g++)if(c=d[g],b.length)for(h=0,j=b.length;j>h;h++)f=b[h],-1!==f.indexOf(c)&&(e+=1);return e===d.length},b.prototype.setupPlugins=function(c,d){var e,f,g,h,i,j,k,l,m;null==c&&(c={}),null==d&&(d={}),j=b.Util.getGlobal(),h=["Unsupported","Auth","Tags","Filter","Store","AnnotateItPermissions"],j.Showdown&&h.push("Markdown"),i=j.location.href.split(/#|\?/).shift()||"",g={Tags:{},Filter:{filters:[{label:b._t("User"),property:"user"},{label:b._t("Tags"),property:"tags"}]},Auth:{tokenUrl:c.tokenUrl||"http://annotateit.org/api/token"},Store:{prefix:c.storeUrl||"http://annotateit.org/api",annotationData:{uri:i},loadFromSearch:{uri:i}}};for(e in d)D.call(d,e)&&(f=d[e],G.call(h,e)<0&&h.push(e));for(a.extend(!0,g,d),m=[],k=0,l=h.length;l>k;k++)e=h[k],m.push(e in g&&!g[e]?void 0:this.addPlugin(e,g[e]));return m}}.call(this);var Showdown={extensions:{}},forEach=Showdown.forEach=function(a,b){if("function"==typeof a.forEach)a.forEach(b);else{var c,d=a.length;for(c=0;d>c;c++)b(a[c],c,a)}},stdExtName=function(a){return a.replace(/[_-]||\s/g,"").toLowerCase()};Showdown.converter=function(a){var b,c,d,e=0,f=[],g=[];if("undefind"!=typeof module&&"undefined"!=typeof exports&&"undefind"!=typeof require){var h=require("fs");if(h){var i=h.readdirSync((__dirname||".")+"/extensions").filter(function(a){return~a.indexOf(".js")}).map(function(a){return a.replace(/\.js$/,"")});Showdown.forEach(i,function(a){var b=stdExtName(a);Showdown.extensions[b]=require("./extensions/"+a)})}}if(this.makeHtml=function(a){return b={},c={},d=[],a=a.replace(/~/g,"~T"),a=a.replace(/\$/g,"~D"),a=a.replace(/\r\n/g,"\n"),a=a.replace(/\r/g,"\n"),a="\n\n"+a+"\n\n",a=M(a),a=a.replace(/^[ \t]+$/gm,""),Showdown.forEach(f,function(b){a=l(b,a)}),a=z(a),a=n(a),a=m(a),a=p(a),a=K(a),a=a.replace(/~D/g,"$$"),a=a.replace(/~T/g,"~"),Showdown.forEach(g,function(b){a=l(b,a)}),a},a&&a.extensions){var j=this;Showdown.forEach(a.extensions,function(a){if("string"==typeof a&&(a=Showdown.extensions[stdExtName(a)]),"function"!=typeof a)throw"Extension '"+a+"' could not be loaded.  It was either not found or is not a valid extension.";Showdown.forEach(a(j),function(a){a.type?"language"===a.type||"lang"===a.type?f.push(a):("output"===a.type||"html"===a.type)&&g.push(a):g.push(a)})})}var k,l=function(a,b){if(a.regex){var c=new RegExp(a.regex,"g");return b.replace(c,a.replace)}return a.filter?a.filter(b):void 0},m=function(a){return a+="~0",a=a.replace(/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|(?=~0))/gm,function(a,d,e,f,g){return d=d.toLowerCase(),b[d]=G(e),f?f+g:(g&&(c[d]=g.replace(/"/g,"&quot;")),"")}),a=a.replace(/~0/,"")},n=function(a){a=a.replace(/\n/g,"\n\n");return a=a.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))/gm,o),a=a.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|style|section|header|footer|nav|article|aside)\b[^\r]*?<\/\2>[ \t]*(?=\n+)\n)/gm,o),a=a.replace(/(\n[ ]{0,3}(<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,o),a=a.replace(/(\n\n[ ]{0,3}<!(--[^\r]*?--\s*)+>[ \t]*(?=\n{2,}))/g,o),a=a.replace(/(?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,o),a=a.replace(/\n\n/g,"\n")},o=function(a,b){var c=b;return c=c.replace(/\n\n/g,"\n"),c=c.replace(/^\n/,""),c=c.replace(/\n+$/g,""),c="\n\n~K"+(d.push(c)-1)+"K\n\n"},p=function(a){a=w(a);var b=A("<hr />");return a=a.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm,b),a=a.replace(/^[ ]{0,2}([ ]?\-[ ]?){3,}[ \t]*$/gm,b),a=a.replace(/^[ ]{0,2}([ ]?\_[ ]?){3,}[ \t]*$/gm,b),a=x(a),a=y(a),a=E(a),a=n(a),a=F(a)},q=function(a){return a=B(a),a=r(a),a=H(a),a=u(a),a=s(a),a=I(a),a=G(a),a=D(a),a=a.replace(/  +\n/g," <br />\n")},r=function(a){var b=/(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--.*?--\s*)+>)/gi;return a=a.replace(b,function(a){var b=a.replace(/(.)<\/?code>(?=.)/g,"$1`");return b=N(b,"\\`*_")})},s=function(a){return a=a.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,t),a=a.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?(.*?(?:\(.*?\).*?)?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,t),a=a.replace(/(\[([^\[\]]+)\])()()()()()/g,t)},t=function(a,d,e,f,g,h,i,j){void 0==j&&(j="");var k=d,l=e,m=f.toLowerCase(),n=g,o=j;if(""==n)if(""==m&&(m=l.toLowerCase().replace(/ ?\n/g," ")),n="#"+m,void 0!=b[m])n=b[m],void 0!=c[m]&&(o=c[m]);else{if(!(k.search(/\(\s*\)$/m)>-1))return k;n=""}n=N(n,"*_");var p='<a href="'+n+'"';return""!=o&&(o=o.replace(/"/g,"&quot;"),o=N(o,"*_"),p+=' title="'+o+'"'),p+=">"+l+"</a>"},u=function(a){return a=a.replace(/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,v),a=a.replace(/(!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,v)},v=function(a,d,e,f,g,h,i,j){var k=d,l=e,m=f.toLowerCase(),n=g,o=j;if(o||(o=""),""==n){if(""==m&&(m=l.toLowerCase().replace(/ ?\n/g," ")),n="#"+m,void 0==b[m])return k;n=b[m],void 0!=c[m]&&(o=c[m])}l=l.replace(/"/g,"&quot;"),n=N(n,"*_");var p='<img src="'+n+'" alt="'+l+'"';return o=o.replace(/"/g,"&quot;"),o=N(o,"*_"),p+=' title="'+o+'"',p+=" />"},w=function(a){function b(a){return a.replace(/[^\w]/g,"").toLowerCase()}return a=a.replace(/^(.+)[ \t]*\n=+[ \t]*\n+/gm,function(a,c){return A('<h1 id="'+b(c)+'">'+q(c)+"</h1>")}),a=a.replace(/^(.+)[ \t]*\n-+[ \t]*\n+/gm,function(a,c){return A('<h2 id="'+b(c)+'">'+q(c)+"</h2>")}),a=a.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm,function(a,c,d){var e=c.length;return A("<h"+e+' id="'+b(d)+'">'+q(d)+"</h"+e+">")})},x=function(a){a+="~0";var b=/^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm;return e?a=a.replace(b,function(a,b,c){var d=b,e=c.search(/[*+-]/g)>-1?"ul":"ol";d=d.replace(/\n{2,}/g,"\n\n\n");var f=k(d);return f=f.replace(/\s+$/,""),f="<"+e+">"+f+"</"+e+">\n"}):(b=/(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g,a=a.replace(b,function(a,b,c,d){var e=b,f=c,g=d.search(/[*+-]/g)>-1?"ul":"ol",f=f.replace(/\n{2,}/g,"\n\n\n"),h=k(f);return h=e+"<"+g+">\n"+h+"</"+g+">\n"})),a=a.replace(/~0/,"")};k=function(a){return e++,a=a.replace(/\n{2,}$/,"\n"),a+="~0",a=a.replace(/(\n)?(^[ \t]*)([*+-]|\d+[.])[ \t]+([^\r]+?(\n{1,2}))(?=\n*(~0|\2([*+-]|\d+[.])[ \t]+))/gm,function(a,b,c,d,e){var f=e,g=b;return g||f.search(/\n{2,}/)>-1?f=p(L(f)):(f=x(L(f)),f=f.replace(/\n$/,""),f=q(f)),"<li>"+f+"</li>\n"}),a=a.replace(/~0/g,""),e--,a};var y=function(a){return a+="~0",a=a.replace(/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g,function(a,b,c){var d=b,e=c;return d=C(L(d)),d=M(d),d=d.replace(/^\n+/g,""),d=d.replace(/\n+$/g,""),d="<pre><code>"+d+"\n</code></pre>",A(d)+e}),a=a.replace(/~0/,"")},z=function(a){return a+="~0",a=a.replace(/(?:^|\n)```(.*)\n([\s\S]*?)\n```/g,function(a,b,c){var d=b,e=c;return e=C(e),e=M(e),e=e.replace(/^\n+/g,""),e=e.replace(/\n+$/g,""),e="<pre><code"+(d?' class="'+d+'"':"")+">"+e+"\n</code></pre>",A(e)}),a=a.replace(/~0/,"")},A=function(a){return a=a.replace(/(^\n+|\n+$)/g,""),"\n\n~K"+(d.push(a)-1)+"K\n\n"},B=function(a){return a=a.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,function(a,b,c,d){var e=d;return e=e.replace(/^([ \t]*)/g,""),e=e.replace(/[ \t]*$/g,""),e=C(e),b+"<code>"+e+"</code>"})},C=function(a){return a=a.replace(/&/g,"&amp;"),a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;"),a=N(a,"*_{}[]\\",!1)},D=function(a){return a=a.replace(/(\*\*|__)(?=\S)([^\r]*?\S[*_]*)\1/g,"<strong>$2</strong>"),a=a.replace(/(\*|_)(?=\S)([^\r]*?\S)\1/g,"<em>$2</em>")},E=function(a){return a=a.replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm,function(a,b){var c=b;return c=c.replace(/^[ \t]*>[ \t]?/gm,"~0"),c=c.replace(/~0/g,""),c=c.replace(/^[ \t]+$/gm,""),c=p(c),c=c.replace(/(^|\n)/g,"$1  "),c=c.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,function(a,b){var c=b;return c=c.replace(/^  /gm,"~0"),c=c.replace(/~0/g,"")}),A("<blockquote>\n"+c+"\n</blockquote>")})},F=function(a){a=a.replace(/^\n+/g,""),a=a.replace(/\n+$/g,"");for(var b=a.split(/\n{2,}/g),c=[],e=b.length,f=0;e>f;f++){var g=b[f];g.search(/~K(\d+)K/g)>=0?c.push(g):g.search(/\S/)>=0&&(g=q(g),g=g.replace(/^([ \t]*)/g,"<p>"),g+="</p>",c.push(g))}e=c.length;for(var f=0;e>f;f++)for(;c[f].search(/~K(\d+)K/)>=0;){var h=d[RegExp.$1];
h=h.replace(/\$/g,"$$$$"),c[f]=c[f].replace(/~K\d+K/,h)}return c.join("\n\n")},G=function(a){return a=a.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;"),a=a.replace(/<(?![a-z\/?\$!])/gi,"&lt;")},H=function(a){return a=a.replace(/\\(\\)/g,O),a=a.replace(/\\([`*_{}\[\]()>#+-.!])/g,O)},I=function(a){return a=a.replace(/<((https?|ftp|dict):[^'">\s]+)>/gi,'<a href="$1">$1</a>'),a=a.replace(/<(?:mailto:)?([-.\w]+\@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)>/gi,function(a,b){return J(K(b))})},J=function(a){var b=[function(a){return"&#"+a.charCodeAt(0)+";"},function(a){return"&#x"+a.charCodeAt(0).toString(16)+";"},function(a){return a}];return a="mailto:"+a,a=a.replace(/./g,function(a){if("@"==a)a=b[Math.floor(2*Math.random())](a);else if(":"!=a){var c=Math.random();a=c>.9?b[2](a):c>.45?b[1](a):b[0](a)}return a}),a='<a href="'+a+'">'+a+"</a>",a=a.replace(/">.+:/g,'">')},K=function(a){return a=a.replace(/~E(\d+)E/g,function(a,b){var c=parseInt(b);return String.fromCharCode(c)})},L=function(a){return a=a.replace(/^(\t|[ ]{1,4})/gm,"~0"),a=a.replace(/~0/g,"")},M=function(a){return a=a.replace(/\t(?=\t)/g,"    "),a=a.replace(/\t/g,"~A~B"),a=a.replace(/~B(.+?)~A/g,function(a,b){for(var c=b,d=4-c.length%4,e=0;d>e;e++)c+=" ";return c}),a=a.replace(/~A/g,"    "),a=a.replace(/~B/g,"")},N=function(a,b,c){var d="(["+b.replace(/([\[\]\\])/g,"\\$1")+"])";c&&(d="\\\\"+d);var e=new RegExp(d,"g");return a=a.replace(e,O)},O=function(a,b){var c=b.charCodeAt(0);return"~E"+c+"E"}},"undefined"!=typeof module&&(module.exports=Showdown),"function"==typeof define&&define.amd&&define("showdown",function(){return Showdown}),Annotator.Plugin.Madison=function(){Annotator.Plugin.apply(this,arguments)},$.extend(Annotator.Plugin.Madison.prototype,new Annotator.Plugin,{events:{},options:{},pluginInit:function(){this.annotator.subscribe("annotationsLoaded",function(a){a.forEach(function(a){a.highlights.forEach(function(b){$(b).attr("id","annotation_"+a.id),$(b).attr("name","annotation_"+a.id),a.link="annotation_"+a.id})});var b=getAnnotationService();b.setAnnotations(a)}),this.annotator.subscribe("annotationCreated",function(a){var b=getAnnotationService();b.addAnnotation(a),$.showAnnotationThanks&&$("#annotationThanks").modal({remote:"/modals/annotation_thanks",keyboard:!0})}),this.annotator.subscribe("commentCreated",function(a){a=$('<div class="existing-comment"><blockquote>'+a.text+'<div class="comment-author">'+a.user.name+"</div></blockquote></div>");var b=$("#current-comments");b.append(a),b.removeClass("hidden"),$("#current-comments").collapse(!0)}),this.annotator.subscribe("annotationViewerTextField",function(a,b){if(0!==b.tags.length){b.tags.forEach(function(c){if("edit"===c){var d=$(a),e=new diff_match_patch,f=e.diff_main(b.quote,b.text),g=e.diff_prettyHtml(f);d.find("p").html(g)}})}}),this.annotator.viewer.addField({load:function(a,b){this.addNoteLink(a,b),this.addNoteActions(a,b),this.addComments(a,b)}.bind(this)}),this.annotator.editor.submit=function(a){this.annotation._error=!1;var b,c,d,e;for(Annotator.Util.preventEventDefault(a),e=this.fields,c=0,d=e.length;d>c;c++)b=e[c],b.submit(b.element,this.annotation);return this.annotation._error!==!0?(this.publish("save",[this.annotation]),this.hide()):void 0},this.annotator.editor.addField({load:function(a,b){this.addEditFields(a,b)}.bind(this),submit:function(a,b){if(this.hasEditTag(b.tags)){var c=$(a).find("#explanation").val();if(""===c.trim())return $("#annotation-error").text("Explanation required for edits.").toggle(!0),b._error=!0,!1;b.explanation=c}},hasEditTag:function(a){var b=!1;return void 0===a||0===a.length?!1:(a.forEach(function(a){"edit"===a&&(b=!0)}),b)}})},addEditFields:function(a,b){var c=$(a),d=$('<div class="annotator-editor-edit-wrapper"></div>'),e=$('<div class="btn-group"></div>'),f=$('<input id="explanation" type="text" name="explanation" placeholder="Why did you make this edit?" style="display:none;" />'),g=$('<p id="annotation-error" style="display:none; color:red;"></p>'),h=$('<button type="button" class="btn btn-default active">Annotate</button>').click(function(){$(this).addClass("active"),$(this).siblings().each(function(){$(this).removeClass("active")}),$("#annotator-field-0").val(""),$("#annotator-field-1").val(""),$("#explanation").toggle(!1),$("#explanation").prop("required",!1),$("#annotator-error").text("").toggle(!1),$("#annotator-field-0").focus()}),i=$('<button type="button" class="btn btn-default">Edit</button>').click(function(){$(this).addClass("active"),$(this).siblings().each(function(){$(this).removeClass("active")}),$("#annotator-field-0").val(b.quote),$("#annotator-field-1").val("edit "),$("#explanation").toggle(!0),$("#explanation").prop("required",!0),$("#annotator-field-0").focus()});e.append(h,i),d.append(e),d.append(f),d.append(g),c.html(d)},addComments:function(a,b){var c=$('<div class="comment-toggle" data-toggle-"collapse" data-target="#current-comments">Comments <span id="comment-caret" class="caret caret-right"></span></button>').click(function(){$("#current-comments").collapse("toggle"),$("#comment-caret").toggleClass("caret-right")});0===$(b.comments).length&&c.addClass("hidden");var d=$('<div id="current-comments" class="current-comments collapse"></div>');if($.each(b.comments,function(a,b){b=$('<div class="existing-comment"><blockquote>'+b.text+'<div class="comment-author">'+b.user.name+"</div></blockquote></div>"),d.append(b)}),d.ready(function(){$("#existing-comments").collapse({toggle:!1})}),""!==user.id){var e=$('<div class="annotation-comments"></div>'),f=$('<input type="text" class="form-control" />'),g=$('<button type="button" class="btn btn-primary" >Submit</button>');g.click(function(){this.createComment(f,b)}.bind(this)),e.append(f),e.append(g),$(a).append(e)}$(a).append(c,d)},addNoteActions:function(a,b){var c=$("<div></div>").addClass("annotation-action"),d=$("<span></span>").addClass("glyphicon").data("annotation-id",b.id),e=d.clone().addClass("glyphicon-thumbs-up").append('<span class="action-count">'+b.likes+"</span>"),f=d.clone().addClass("glyphicon-thumbs-down").append('<span class="action-count">'+b.dislikes+"</span>"),g=d.clone().addClass("glyphicon-flag").append('<span class="action-count">'+b.flags+"</span>");if(c.append(e,f,g),""!==user.id){b.user_action&&("like"===b.user_action?e.addClass("selected"):"dislike"===b.user_action?f.addClass("selected"):"flag"===b.user_action&&g.addClass("selected"));var h=this;e.addClass("logged-in").click(function(){h.addLike(b,this)}),f.addClass("logged-in").click(function(){h.addDislike(b,this)}),g.addClass("logged-in").click(function(){h.addFlag(b,this)})}$(a).append(c)},addNoteLink:function(a,b){var c=$('<div class="annotation-link"></div>'),d=window.location.origin+window.location.pathname+"#"+b.link,e=$("<a></a>").attr("href",window.location.pathname+"#"+b.link).text("Copy Annotation Link").addClass("annotation-permalink");e.attr("data-clipboard-text",d);new ZeroClipboard(e);c.append(e),$(a).append(c)},createComment:function(a,b){var c=a.val();a.val("");var d={text:c,user:user};$.post("/api/docs/"+doc.id+"/annotations/"+b.id+"/comments",{comment:d},function(){return b.comments.push(d),this.annotator.publish("commentCreated",d)}.bind(this))},addLike:function(a,b){$.post("/api/docs/"+doc.id+"/annotations/"+a.id+"/likes",function(c){b=$(b),b.children(".action-count").text(c.likes),b.siblings(".glyphicon").removeClass("selected"),c.action?b.addClass("selected"):b.removeClass("selected"),b.siblings(".glyphicon-thumbs-up").children(".action-count").text(c.likes),b.siblings(".glyphicon-thumbs-down").children(".action-count").text(c.dislikes),b.siblings(".glyphicon-flag").children(".action-count").text(c.flags),a.likes=c.likes,a.dislikes=c.dislikes,a.flags=c.flags,a.user_action="like"})},addDislike:function(a,b){$.post("/api/docs/"+doc.id+"/annotations/"+a.id+"/dislikes",function(c){b=$(b),b.children(".action-count").text(c.dislikes),b.siblings(".glyphicon").removeClass("selected"),c.action?b.addClass("selected"):b.removeClass("selected"),b.siblings(".glyphicon-thumbs-up").children(".action-count").text(c.likes),b.siblings(".glyphicon-thumbs-down").children(".action-count").text(c.dislikes),b.siblings(".glyphicon-flag").children(".action-count").text(c.flags),a.likes=c.likes,a.dislikes=c.dislikes,a.flags=c.flags,a.user_action="dislike"})},addFlag:function(a,b){$.post("/api/docs/"+doc.id+"/annotations/"+a.id+"/flags",function(c){b=$(b),b.children(".action-count").text(c.flags),b.siblings(".glyphicon").removeClass("selected"),c.action?b.addClass("selected"):b.removeClass("selected"),b.siblings(".glyphicon-thumbs-up").children(".action-count").text(c.likes),b.siblings(".glyphicon-thumbs-down ").children(".action-count").text(c.dislikes),a.likes=c.likes,a.dislikes=c.dislikes,a.flags=c.flags,a.user_action="flag"})}});